
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-chrome .ace_gutter {background: #ebebeb;color: #333;overflow : hidden;}.ace-chrome .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-chrome {background-color: #FFFFFF;color: black;}.ace-chrome .ace_cursor {color: black;}.ace-chrome .ace_invisible {color: rgb(191, 191, 191);}.ace-chrome .ace_constant.ace_buildin {color: rgb(88, 72, 246);}.ace-chrome .ace_constant.ace_language {color: rgb(88, 92, 246);}.ace-chrome .ace_constant.ace_library {color: rgb(6, 150, 14);}.ace-chrome .ace_invalid {background-color: rgb(153, 0, 0);color: white;}.ace-chrome .ace_fold {}.ace-chrome .ace_support.ace_function {color: rgb(60, 76, 114);}.ace-chrome .ace_support.ace_constant {color: rgb(6, 150, 14);}.ace-chrome .ace_support.ace_type,.ace-chrome .ace_support.ace_class.ace-chrome .ace_support.ace_other {color: rgb(109, 121, 222);}.ace-chrome .ace_variable.ace_parameter {font-style:italic;color:#FD971F;}.ace-chrome .ace_keyword.ace_operator {color: rgb(104, 118, 135);}.ace-chrome .ace_comment {color: #236e24;}.ace-chrome .ace_comment.ace_doc {color: #236e24;}.ace-chrome .ace_comment.ace_doc.ace_tag {color: #236e24;}.ace-chrome .ace_constant.ace_numeric {color: rgb(0, 0, 205);}.ace-chrome .ace_variable {color: rgb(49, 132, 149);}.ace-chrome .ace_xml-pe {color: rgb(104, 104, 91);}.ace-chrome .ace_entity.ace_name.ace_function {color: #0000A2;}.ace-chrome .ace_heading {color: rgb(12, 7, 255);}.ace-chrome .ace_list {color:rgb(185, 6, 144);}.ace-chrome .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-chrome .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-chrome .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-chrome .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-chrome .ace_marker-layer .ace_active-line {background: rgba(0, 0, 0, 0.07);}.ace-chrome .ace_gutter-active-line {background-color : #dcdcdc;}.ace-chrome .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-chrome .ace_storage,.ace-chrome .ace_keyword,.ace-chrome .ace_meta.ace_tag {color: rgb(147, 15, 128);}.ace-chrome .ace_string.ace_regex {color: rgb(255, 0, 0)}.ace-chrome .ace_string {color: #1A1AA6;}.ace-chrome .ace_entity.ace_other.ace_attribute-name {color: #994409;}.ace-chrome .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      <div id="nav"><div>Next: <a href='11 - Spring Cloud Config-Get updated config file by dynamic refresh.html'>11 - Spring Cloud Config-Get updated config file by dynamic refresh</a>, Previous: <a href='9 - Spring Cloud Config-Set up.html'>9 - Spring Cloud Config-Set up</a>, Up: <a href='index.html'>Index</a></div></div>
      <div id="titlearea">
        <h2>10 - Spring Cloud Config-Get updated config file by manually refresh</h2>
      </div>
      <div id="contentarea"><div class="cell text-cell"><h3>10.1 Manually fresh using actuator</h3></div><div class="cell text-cell">In order to solve the problem that the latest configuration cannot be obtained without restarting the Config client, next, we will modify micro-service-cloud-config-client-3355, and the modification steps are as follows.</div><div class="cell text-cell">(1). Add the following dependencies to the pom.xml of micro-service-cloud-config-client-3355, and introduce the Spring Boot actuator monitoring module.</div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag ace_punctuation ace_tag-open ace_xml">&lt;</span><span class="ace_meta ace_tag ace_tag-name ace_xml">dependency</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_text ace_xml">    </span><span class="ace_meta ace_tag ace_punctuation ace_tag-open ace_xml">&lt;</span><span class="ace_meta ace_tag ace_tag-name ace_xml">groupId</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span><span class="ace_text ace_xml">org.springframework.boot</span><span class="ace_meta ace_tag ace_punctuation ace_end-tag-open ace_xml">&lt;/</span><span class="ace_meta ace_tag ace_tag-name ace_xml">groupId</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_text ace_xml">    </span><span class="ace_meta ace_tag ace_punctuation ace_tag-open ace_xml">&lt;</span><span class="ace_meta ace_tag ace_tag-name ace_xml">artifactId</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span><span class="ace_text ace_xml">spring-boot-starter-actuator</span><span class="ace_meta ace_tag ace_punctuation ace_end-tag-open ace_xml">&lt;/</span><span class="ace_meta ace_tag ace_tag-name ace_xml">artifactId</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag ace_punctuation ace_end-tag-open ace_xml">&lt;/</span><span class="ace_meta ace_tag ace_tag-name ace_xml">dependency</span><span class="ace_meta ace_tag ace_punctuation ace_tag-close ace_xml">&gt;</span>
</div></div></div></div><div class="cell text-cell">(2). Add the following configuration in the configuration file bootstrap.yml to expose the monitoring nodes of Spring Boot actuator to the outside world.</div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Spring Boot 2.50 screens most of the nodes for actuator monitoring, and only exposes the health node. The configuration (*) in this section is to enable all nodes</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">management</span><span class="ace_keyword">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">  endpoints</span><span class="ace_keyword">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">    web</span><span class="ace_keyword">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_meta ace_tag">  exposure</span><span class="ace_keyword">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_meta ace_tag">    include</span><span class="ace_keyword">: </span><span class="ace_string">"*"</span>   <span class="ace_comment"># * is a keyword in the yaml file, so quotation marks are required</span>
</div></div></div></div><div class="cell text-cell">(3). Use the @RefreshScope annotation on the ConfigClientController class to enable configuration refresh. The code is as follows.</div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">package</span> <span class="ace_identifier">com</span>.<span class="ace_identifier">luxbp</span>.<span class="ace_identifier">controller</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">import</span> <span class="ace_identifier">org</span>.<span class="ace_identifier">springframework</span>.<span class="ace_identifier">beans</span>.<span class="ace_identifier">factory</span>.<span class="ace_identifier">annotation</span>.<span class="ace_identifier">Value</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">import</span> <span class="ace_identifier">org</span>.<span class="ace_identifier">springframework</span>.<span class="ace_identifier">cloud</span>.<span class="ace_identifier">context</span>.<span class="ace_identifier">config</span>.<span class="ace_identifier">annotation</span>.<span class="ace_identifier">RefreshScope</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">import</span> <span class="ace_identifier">org</span>.<span class="ace_identifier">springframework</span>.<span class="ace_identifier">web</span>.<span class="ace_identifier">bind</span>.<span class="ace_identifier">annotation</span>.<span class="ace_identifier">GetMapping</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">import</span> <span class="ace_identifier">org</span>.<span class="ace_identifier">springframework</span>.<span class="ace_identifier">web</span>.<span class="ace_identifier">bind</span>.<span class="ace_identifier">annotation</span>.<span class="ace_identifier">RestController</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//Read the content of the specified configuration file in the configuration center and display it on the page</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@<span class="ace_identifier">RefreshScope</span> <span class="ace_comment">//In order to get the latest git configuration dynamically (manually), add the actuator to monitor and load RefreshScope,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>@<span class="ace_identifier">RestController</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">public</span> <span class="ace_keyword">class</span> <span class="ace_identifier">ConfigClientController</span> {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    @<span class="ace_identifier">Value</span>(<span class="ace_string">"${server.port}"</span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">private</span> <span class="ace_support ace_function">String</span> <span class="ace_identifier">serverPort</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    @<span class="ace_identifier">Value</span>(<span class="ace_string">"${config.info}"</span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">private</span> <span class="ace_support ace_function">String</span> <span class="ace_identifier">configInfo</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    @<span class="ace_identifier">Value</span>(<span class="ace_string">"${config.version}"</span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">private</span> <span class="ace_support ace_function">String</span> <span class="ace_identifier">configVersion</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    @<span class="ace_identifier">GetMapping</span>(<span class="ace_identifier">value</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">"/getConfig"</span>)
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">public</span> <span class="ace_support ace_function">String</span> <span class="ace_identifier">getConfig</span>() {
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword">return</span> <span class="ace_string">"info<span class="ace_cjk" style="width:NaNpx">：</span>"</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">configInfo</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_string">"&lt;br/&gt;version<span class="ace_cjk" style="width:NaNpx">：</span>"</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">configVersion</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_string">"&lt;br/&gt;port<span class="ace_cjk" style="width:NaNpx">：</span>"</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">serverPort</span>;
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    }
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>}
</div></div></div></div><div class="cell text-cell">(4). Restart micro-service-cloud-config-client-3355, and then modify the config.version in the configuration file config-dev.yml to 3.0, the configuration is as follows.</div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">config</span><span class="ace_keyword">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">  info</span><span class="ace_keyword">: </span>com.luxbp engin
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_meta ace_tag">  version</span><span class="ace_keyword">: </span><span class="ace_constant ace_numeric">0.0.3</span>
</div></div></div></div><div class="cell text-cell">(5). Use the browser to access "<a href="http://localhost:3355/getConfig">http://localhost:3355/getConfig</a>" again, and the result is as shown in the figure below.</div><div class="cell text-cell"><img src="resources/D83B6C321C27BE1C58920306639D7350.png" alt="Screen Shot 2023-02-27 at 9.43.57 AM.png" width="193" height="86"></div><div class="cell text-cell">As can be seen from the above figure, even if we modify the Spring Cloud Config client, we still cannot directly obtain the latest configuration.<div><br></div><div>The reason is that we have not notified the actuator monitoring module to refresh the configuration. The code in this section is no different from the code in the previous section. In terms of architecture, the main difference is that we have added an actuator in this part. The so-called manual refresh means that we send a message to the actuator integrated in the client, and let the actuator notify the client to pull information. It should be noted that if there are multiple clients, you need to send messages to the actuators of each client separately.</div></div><div class="cell text-cell">(6). Open the command line window, use the following command to send a POST request to refresh the Spring Cloud Config 3355 client, and notify the client that the configuration file has been modified and the configuration needs to be pulled again.</div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">curl</span> <span class="ace_keyword ace_operator">-</span><span class="ace_identifier">X</span> <span class="ace_identifier">POST</span> <span class="ace_string">"http://localhost:3355/actuator/refresh"</span>
</div></div></div></div><div class="cell text-cell">7. Use the browser to visit "<a href="http://localhost:3355/getConfig">http://localhost:3355/getConfig</a>" again, and the result is as shown in the figure below.<div><img src="resources/17999910B2AB94F339FF284F4C5FF15D.png" alt="Screen Shot 2023-03-02 at 9.57.06 AM.png" width="178" height="98"><br></div></div><div class="cell text-cell"><h3>10.1 Problems in manually refresh</h3></div><div class="cell text-cell">…...</div><div class="cell text-cell"></div></div>
      <script>document.body.onkeyup = function(e) {
if (e.keyCode === 39) window.location.href = '11 - Spring Cloud Config-Get updated config file by dynamic refresh.html';
if (e.keyCode === 37) window.location.href = '9 - Spring Cloud Config-Set up.html';
}</script>
    </body>
    </html>
  